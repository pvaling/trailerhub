---
- name: Deploy dreams app
  hosts: dreams-servers-stand
  gather_facts: false
  vars_files:
    - vars.yml
  tasks:

  - name: pull changes
    become: yes
    become_user: dreams
    git:
      repo: git@github.com:pvaling/dreams.git
      dest: /opt/projects/dreams/
      version: dev
      force: yes
      accept_hostkey: yes
      update: yes
      recursive: yes
      remote: origin

  - name: pip install
    become: yes
    become_user: dreams
    pip:
      requirements: /opt/projects/dreams/requirements.txt
      virtualenv: /usr/local/envs/dreams/

  - name: restart uwsgi via supervisor
    become: yes
    supervisorctl:
      state: restarted
      name: "dreams_uwsgi_prod"

  # - name: restart default queue via supervisor
  #   become: yes
  #   supervisorctl:
  #     state: restarted
  #     name: "dreams_celery_prod_default"
